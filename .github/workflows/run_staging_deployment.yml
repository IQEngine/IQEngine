---
name: Deploy To Staging

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  create_pre_release:
    uses: ./.github/workflows/docker-pre-release.yml
    permissions:
      contents: write
      pull-requests: write
      packages: write

  run_staging_deployment:
    if: github.repository == 'IQEngine/IQEngine'
    needs: create_pre_release
    permissions:
      contents: write
      pull-requests: write
      packages: write
    runs-on: ubuntu-latest
    environment:
      name: 'Staging'
      url: https://staging.iqengine.org
    env:
      repository: ${{needs.create_pre_release.outputs.repository}}
      sha: ${{needs.create_pre_release.outputs.sha}}
    steps:
      - name: Log in with Azure with Service Principal
        uses: azure/login@cb79c773a3cfa27f31f25eb3f677781210c9ce3d # v1.6.1
        with:
          creds: '${{ secrets.AZURE_CREDENTIALS }}'

      - name: Build and Deploy Frontend+Backend Container App
        uses: azure/container-apps-deploy-action@02d045129c058b13312276b50a552834cf74e2af # v1
        with:
          containerAppName: ${{ secrets.AZURE_CONTAINER_APP_NAME }}
          resourceGroup: ${{ secrets.AZURE_RESOURCEGROUP }}
          imageToDeploy: ghcr.io/${{ env.repository }}:${{ env.sha}}

      - name: Build and Deploy Plugins Container App
        uses: azure/container-apps-deploy-action@02d045129c058b13312276b50a552834cf74e2af # v1
        with:
          containerAppName: ${{ secrets.AZURE_CONTAINER_APP_NAME_STAGING_PLUGINS }}
          resourceGroup: ${{ secrets.AZURE_RESOURCEGROUP }}
          imageToDeploy: ghcr.io/${{ env.repository }}-plugins:${{ env.sha}}
